{% extends 'base.html' %}

{% block title %}Forest Monitoring Dashboard{% endblock %}

{% block content %}
<header class="header">
    <div class="container">
        <div class="header-content">
            <div class="logo">Forest Watch</div>
            <nav class="navbar">
                <a href="#overview" class="nav-link">Overview</a>
                <a href="#map" class="nav-link">Map</a>
                <a href="#analytics" class="nav-link">Analytics</a>
                <a href="#alerts" class="nav-link">Alerts</a>
                {% if user.is_authenticated %}
                <a href="{% url 'logout' %}" class="nav-link">Logout</a>
                {% else %}
                <a href="{% url 'login' %}" class="nav-link">Login</a>
                {% endif %}
            </nav>
        </div>
    </div>
</header>

<section class="hero">
    <div class="container">
        <div class="hero-content">
            <h1>Forest Monitoring Dashboard</h1>
            <p>Real-time tracking and analysis of forest health, biodiversity, and environmental metrics</p>
            <button class="cta-button">Start Monitoring</button>
        </div>
    </div>
</section>

<section id="overview" class="dashboard-overview">
    <div class="container">
        <h2 class="section-title">Real-Time Metrics</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">{{ total_area_ha }}</div>
                <h3>Forest Coverage</h3>
                <div class="metric-value">{{ total_area_ha }}</div>
                <div class="metric-subtitle">hectares monitored</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">{{ avg_health }}%</div>
                <h3>Vegetation Health</h3>
                <div class="metric-value">{{ avg_health }}%</div>
                <div class="metric-subtitle">healthy coverage</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">{{ active_alerts }}</div>
                <h3>Active Alerts</h3>
                <div class="metric-value">{{ active_alerts }}</div>
                <div class="metric-subtitle">detected hotspots</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">{{ total_loss }}</div>
                <h3>Total Loss</h3>
                <div class="metric-value">{{ total_loss }}</div>
                <div class="metric-subtitle">hectares deforested</div>
            </div>
        </div>
    </div>
</section>

<section id="map" class="map-section">
    <div class="container">
        <h2 class="section-title">Interactive Monitoring</h2>

        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

        <!-- Map Container -->
        <div id="forest-map"
            style="height: 600px; width: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid rgba(16, 185, 129, 0.2);">
        </div>

        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var map = L.map('forest-map').setView([48.8566, 2.3522], 6);

                var baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(map);

                // Layer Groups
                var forestLayers = L.layerGroup().addTo(map);
                var lossLayers = L.layerGroup().addTo(map);
                var alertMarkers = L.layerGroup().addTo(map);
                var aoiBoundaries = L.layerGroup().addTo(map);

                var overlayMaps = {
                    "Forest Cover (Live)": forestLayers,
                    "Deforestation Hotspots": lossLayers,
                    "Markers": alertMarkers,
                    "Monitored Areas": aoiBoundaries
                };

                var layerControl = L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

                // Add Loading Indicator (Simple Console for now, can be UI)
                console.log("SilvaGuard: Initializing Monitor...");

                fetch('/satellite/api/map-data/')
                    .then(response => response.json())
                    .then(data => {
                        console.log("SilvaGuard: Map data received", data);

                        // 0. Add Regional Baseline (Whole Map)
                        if (data.global_tile_url && data.global_tile_url.trim() !== '') {
                            console.log("SilvaGuard: Loading Global Forest Baseline...");
                            var globalMosaic = L.tileLayer(data.global_tile_url, {
                                opacity: 0.6,
                                attribution: 'GEE Mosaic'
                            });
                            globalMosaic.addTo(map);
                            layerControl.addOverlay(globalMosaic, "Global Forest Baseline");
                        }

                        if (data.features.length > 0) {
                            data.features.forEach(f => {
                                // 1. Forest Cover Tile
                                if (f.properties.type === 'AOI' && f.properties.tile_url) {
                                    L.tileLayer(f.properties.tile_url, {
                                        opacity: 0.7,
                                        attribution: 'GEE'
                                    }).addTo(forestLayers);

                                    // AOI Boundary
                                    L.circle([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
                                        color: '#10b981',
                                        fillOpacity: 0.05,
                                        radius: (f.properties.radius_km * 1000)
                                    }).bindPopup(f.properties.popup).addTo(aoiBoundaries);
                                }

                                // 2. Alert & Loss Layer
                                if (f.properties.type === 'Alert') {
                                    if (f.properties.tile_url) {
                                        L.tileLayer(f.properties.tile_url, {
                                            opacity: 0.9,
                                            attribution: 'GEE Loss'
                                        }).addTo(lossLayers);
                                    }

                                    L.circleMarker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
                                        radius: 12,
                                        fillColor: "#ef4444",
                                        color: "#ffffff",
                                        weight: 2,
                                        fillOpacity: 0.8
                                    }).bindPopup(f.properties.popup).addTo(alertMarkers);
                                }
                            });

                            // Zoom to fit
                            try {
                                if (data.features && data.features.length > 0) {
                                    var geoJsonLayer = L.geoJSON(data);
                                    var bounds = geoJsonLayer.getBounds();
                                    if (bounds.isValid()) {
                                        map.fitBounds(bounds, { padding: [50, 50] });
                                    }
                                } else {
                                    console.log("SilvaGuard: Global mode - World View");
                                    map.setView([20, 0], 2); // World center sort of
                                }
                            } catch (e) {
                                console.error("SilvaGuard: fitBounds failed", e);
                            }
                        } else {
                            console.warn("SilvaGuard: No features found in API response");
                            map.setView([20, 0], 2); // Fallback to world view
                        }
                    })
                    .catch(error => console.error('Error:', error));
            });
        </script>

        <div class="risk-meter" style="margin-top: 1rem;">
            <p class="analytics-label">Map displays monitored Areas of Interest (Green) and Deforestation Alerts (Red).
            </p>
        </div>
    </div>
</section>

<section id="alerts" class="alerts-section">
    <div class="container">
        <h2 class="section-title">Active Alerts</h2>
        <div class="alerts-list">
            <div class="alert-item alert-low">
                <div class="alert-header">
                    <h4>Seasonal Growth Detected</h4>
                    <span class="alert-badge alert-badge-low">Low</span>
                </div>
                <p class="alert-time">2 hours ago</p>
                <p class="alert-description">Vegetation growth increased by 12% in the northern sector. This is expected
                    seasonal growth pattern.</p>
            </div>
            <div class="alert-item alert-medium">
                <div class="alert-header">
                    <h4>Water Stress Moderate</h4>
                    <span class="alert-badge alert-badge-medium">Medium</span>
                </div>
                <p class="alert-time">4 hours ago</p>
                <p class="alert-description">Soil moisture levels in central zone have decreased to 62%. Monitor for
                    potential intervention.</p>
            </div>
            <div class="alert-item alert-low">
                <div class="alert-header">
                    <h4>Wildlife Activity Normal</h4>
                    <span class="alert-badge alert-badge-low">Low</span>
                </div>
                <p class="alert-time">8 hours ago</p>
                <p class="alert-description">Camera traps recorded 47 species movements today, all within expected
                    parameters for this season.</p>
            </div>
        </div>
    </div>
</section>

<section class="about-section">
    <div class="container">
        <h2 class="section-title">Our Mission</h2>
        <div class="about-content">
            <div class="about-card">
                <h3>Real-Time Monitoring</h3>
                <p>Continuous satellite and sensor data collection providing live insights into forest health and
                    environmental changes.</p>
            </div>
            <div class="about-card">
                <h3>Data-Driven Decision Making</h3>
                <p>Advanced analytics and predictive models help managers make informed decisions about forest
                    conservation and management.</p>
            </div>
            <div class="about-card">
                <h3>Biodiversity Protection</h3>
                <p>Comprehensive species tracking and habitat monitoring ensure ecosystem resilience and long-term
                    conservation success.</p>
            </div>
        </div>
    </div>
</section>

<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <p>Forest Watch Dashboard</p>
            <p class="footer-message">Protecting forests, preserving biodiversity, securing our future</p>
            <p>&copy; 2026 Forest Watch. All rights reserved.</p>
        </div>
    </div>
</footer>
{% endblock %}