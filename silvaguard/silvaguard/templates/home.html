{% extends 'base.html' %}

{% block title %}Forest Monitoring Dashboard{% endblock %}

{% block content %}

<section class="hero">
    <div class="container">
        <div class="hero-content">
            <h1>Forest Monitoring Dashboard</h1>
            <p>Real-time tracking and analysis of forest health, biodiversity, and environmental metrics</p>
            <form action="{% url 'guard_pulse_trigger' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="cta-button">Initiate Pulse Check</button>
            </form>
            <a href="{% url 'aoi_list' %}" class="cta-button"
                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); margin-left: 1rem; text-decoration: none; display: inline-block;">Manage
                Zones</a>
        </div>
    </div>
</section>

<section id="overview" class="dashboard-overview">
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 class="section-title" style="margin-bottom: 0;">Real-Time Metrics</h2>
            <div
                style="background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 0.5rem 1rem; border-radius: 999px; font-weight: 500; border: 1px solid rgba(16, 185, 129, 0.3);">
                Mode: {{ mode }}
            </div>
        </div>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">{{ total_area_ha }}</div>
                <h3>Forest Coverage</h3>
                <div class="metric-value">{{ total_area_ha }}</div>
                <div class="metric-subtitle">hectares monitored</div>
                <a href="{% url 'aoi_create' %}"
                    style="display: block; margin-top: 1rem; color: #10b981; font-size: 0.875rem; font-weight: 600;">+
                    Add New Zone</a>
            </div>
            <div class="metric-card">
                <div class="metric-icon">{{ avg_health }}%</div>
                <h3>Vegetation Health</h3>
                <div class="metric-value">{{ avg_health }}%</div>
                <div class="metric-subtitle">healthy coverage</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">{{ active_alerts }}</div>
                <h3>Active Alerts</h3>
                <div class="metric-value">{{ active_alerts }}</div>
                <div class="metric-subtitle">detected hotspots</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">{{ total_loss }}</div>
                <h3>Total Loss</h3>
                <div class="metric-value">{{ total_loss }}</div>
                <div class="metric-subtitle">hectares deforested</div>
            </div>
        </div>
    </div>
</section>

<section id="map" class="map-section">
    <div class="container">
        <h2 class="section-title">Interactive Monitoring</h2>

        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

        <!-- Map Container -->
        <div id="forest-map"
            style="height: 600px; width: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 1px solid rgba(16, 185, 129, 0.2);">
        </div>

        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                var map = L.map('forest-map').setView([48.8566, 2.3522], 6);

                var baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(map);

                // Layer Groups
                var forestLayers = L.layerGroup().addTo(map);
                var lossLayers = L.layerGroup().addTo(map);
                var alertMarkers = L.layerGroup().addTo(map);
                var aoiBoundaries = L.layerGroup().addTo(map);

                var overlayMaps = {
                    "Forest Cover (Live)": forestLayers,
                    "Deforestation Hotspots": lossLayers,
                    "Markers": alertMarkers,
                    "Monitored Areas": aoiBoundaries
                };

                var layerControl = L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

                // Add Loading Indicator (Simple Console for now, can be UI)
                console.log("SilvaGuard: Initializing Monitor...");

                fetch('/satellite/api/map-data/')
                    .then(response => response.json())
                    .then(data => {
                        console.log("SilvaGuard: Map data received", data);

                        // 0. Add Regional Baseline (Whole Map)
                        if (data.global_tile_url && data.global_tile_url.trim() !== '') {
                            console.log("SilvaGuard: Loading Global Forest Baseline...");
                            var globalMosaic = L.tileLayer(data.global_tile_url, {
                                opacity: 1.0, // Full visibility for global baseline
                                attribution: 'GFW / Hansen',
                                zIndex: 1
                            });
                            globalMosaic.addTo(map);
                            layerControl.addOverlay(globalMosaic, "Global Baseline");
                        }

                        if (data.features.length > 0) {
                            data.features.forEach(f => {
                                // 1. Forest Cover Tile
                                if (f.properties.type === 'AOI' && f.properties.tile_url) {
                                    L.tileLayer(f.properties.tile_url, {
                                        opacity: 1.0, // Vibrant markers
                                        attribution: 'SilvaGuard Focus',
                                        zIndex: 10 // High priority
                                    }).addTo(forestLayers);

                                    // AOI Boundary
                                    L.circle([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
                                        color: '#10b981',
                                        fillOpacity: 0.05,
                                        radius: (f.properties.radius_km * 1000)
                                    }).bindPopup(f.properties.popup).addTo(aoiBoundaries);
                                }

                                // 2. Alert & Loss Layer
                                if (f.properties.type === 'Alert') {
                                    if (f.properties.tile_url) {
                                        L.tileLayer(f.properties.tile_url, {
                                            opacity: 0.9,
                                            attribution: 'GEE Loss'
                                        }).addTo(lossLayers);
                                    }

                                    L.circleMarker([f.geometry.coordinates[1], f.geometry.coordinates[0]], {
                                        radius: 12,
                                        fillColor: "#ef4444",
                                        color: "#ffffff",
                                        weight: 2,
                                        fillOpacity: 0.8
                                    }).bindPopup(f.properties.popup).addTo(alertMarkers);
                                }
                            });

                            // Zoom to fit
                            try {
                                if (data.features && data.features.length > 0) {
                                    var geoJsonLayer = L.geoJSON(data);
                                    var bounds = geoJsonLayer.getBounds();
                                    if (bounds.isValid()) {
                                        map.fitBounds(bounds, { padding: [50, 50] });
                                    }
                                } else {
                                    console.log("SilvaGuard: Global mode - World View");
                                    map.setView([20, 0], 2); // World center sort of
                                }
                            } catch (e) {
                                console.error("SilvaGuard: fitBounds failed", e);
                            }
                        } else {
                            console.warn("SilvaGuard: No features found in API response");
                            map.setView([20, 0], 2); // Fallback to world view
                        }
                    })
                    .catch(error => console.error('Error:', error));

                // Add Legend
                var legend = L.control({ position: 'bottomright' });
                legend.onAdd = function (map) {
                    var div = L.DomUtil.create('div', 'info legend');
                    div.style.backgroundColor = 'rgba(15, 23, 42, 0.9)';
                    div.style.color = 'white';
                    div.style.padding = '1rem';
                    div.style.borderRadius = '8px';
                    div.style.border = '1px solid rgba(16, 185, 129, 0.4)';
                    div.style.lineHeight = '1.5';
                    div.innerHTML = `
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.875rem;">Map Legend</h4>
                        <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                            <span style="width: 12px; height: 12px; background: #10b981; border-radius: 50%; display: inline-block; margin-right: 8px;"></span>
                            <span style="font-size: 0.75rem;">Monitored Area</span>
                        </div>
                        <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                            <span style="width: 12px; height: 12px; background: #ff4757; border-radius: 50%; display: inline-block; margin-right: 8px;"></span>
                            <span style="font-size: 0.75rem;">Recent Loss</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="width: 12px; height: 12px; background: #2ecc71; display: inline-block; margin-right: 8px;"></span>
                            <span style="font-size: 0.75rem;">Tree Cover (Hansen)</span>
                        </div>
                    `;
                    return div;
                };
                legend.addTo(map);

                // Global function to focus on specific coordinates
                window.focusOnAlert = function (lat, lon) {
                    map.setView([lat, lon], 14);
                    // Add a temporary highlight circle or something?
                    var pulse = L.circle([lat, lon], {
                        radius: 500,
                        color: '#ef4444',
                        fillColor: '#ef4444',
                        weight: 2,
                        fillOpacity: 0.1
                    }).addTo(map);

                    setTimeout(() => map.removeLayer(pulse), 3000);

                    // Scroll to map
                    document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
                };
            });
        </script>

        <div class="risk-meter" style="margin-top: 1rem;">
            <p class="analytics-label">Map displays monitored Areas of Interest (Green) and Deforestation Alerts (Red).
            </p>
        </div>
    </div>
</section>

<section id="alerts" class="alerts-section">
    <div class="container">
        <h2 class="section-title">Active Alerts</h2>
        <div class="alerts-list">
            {% for alert in recent_alerts %}
            <div
                class="alert-item {% if alert.loss_percentage > 5 %}alert-high{% elif alert.loss_percentage > 2 %}alert-medium{% else %}alert-low{% endif %}">
                <div class="alert-header">
                    <h4>Deforestation Detected: {{ alert.aoi.name }}</h4>
                    <span
                        class="alert-badge {% if alert.loss_percentage > 5 %}alert-badge-high{% elif alert.loss_percentage > 2 %}alert-badge-medium{% else %}alert-badge-low{% endif %}">
                        {% if alert.loss_percentage > 5 %}Critical{% elif alert.loss_percentage > 2 %}High Risk{% else
                        %}Moderate{% endif %}
                    </span>
                </div>
                <p class="alert-time">{{ alert.detected_at|timesince }} ago</p>
                <p class="alert-description">
                    Estimated loss of <strong>{{ alert.forest_loss_hectares|floatformat:2 }} ha</strong>
                    ({{ alert.loss_percentage|floatformat:1 }}% of forest cover) detected between
                    {{ alert.analysis_before.processed_image.satellite_image.acquisition_date|date:"M d" }} and
                    {{ alert.analysis_after.processed_image.satellite_image.acquisition_date|date:"M d" }}.
                </p>
                {% if alert.loss_map_path %}
                <a href="#" data-lat="{{ alert.aoi.latitude|stringformat:'f' }}"
                    data-lon="{{ alert.aoi.longitude|stringformat:'f' }}"
                    onclick="focusOnAlert(parseFloat(this.dataset.lat), parseFloat(this.dataset.lon)); return false;"
                    style="color: #10b981; font-size: 0.875rem; font-weight: 600; text-decoration: none; margin-top: 0.5rem; display: inline-block;">View
                    on Map →</a>
                <a href="{% url 'alert_detail' alert.pk %}"
                    style="color: #64748b; font-size: 0.875rem; font-weight: 600; text-decoration: none; margin-top: 0.5rem; display: inline-block; margin-left: 1rem;">View
                    Full Report →</a>
                {% endif %}
            </div>
            {% empty %}
            <div class="alert-item alert-low" style="text-align: center; border: 1px dashed rgba(16, 185, 129, 0.3);">
                <p style="margin: 0; color: #94a3b8;">No deforestation alerts detected in recent pulses.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<section class="about-section">
    <div class="container">
        <h2 class="section-title">Our Mission</h2>
        <div class="about-content">
            <div class="about-card">
                <h3>Real-Time Monitoring</h3>
                <p>Continuous satellite and sensor data collection providing live insights into forest health and
                    environmental changes.</p>
            </div>
            <div class="about-card">
                <h3>Data-Driven Decision Making</h3>
                <p>Advanced analytics and predictive models help managers make informed decisions about forest
                    conservation and management.</p>
            </div>
            <div class="about-card">
                <h3>Biodiversity Protection</h3>
                <p>Comprehensive species tracking and habitat monitoring ensure ecosystem resilience and long-term
                    conservation success.</p>
            </div>
        </div>
    </div>
</section>

<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <p>SilvaGuard Dashboard</p>
            <p class="footer-message">Protecting forests, preserving biodiversity, securing our future</p>
            <p>&copy; 2026 SilvaGuard. All rights reserved.</p>
        </div>
    </div>
</footer>
{% endblock %}